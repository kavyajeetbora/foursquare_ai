<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sales Query Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Simple CSS for layout -->
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* prevent page from scrolling; chat will scroll internally */
        }
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
        .container {
            display: flex;
            height: 100vh;
            overflow: hidden; /* ensure children control internal scrolling */
        }
        /* Side Panel */
        .side-panel {
            width: 260px;
            background: #f4f4f4;
            border-right: 1px solid #ddd;
            padding: 20px;
            box-sizing: border-box;
            transition: width 0.3s;
            display: flex;
            flex-direction: column;
        }
        .side-panel.collapsed {
            width: 60px;
            padding: 20px 5px;
        }
        .collapse-btn {
            background: #0078d4;
            color: #fff;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .dropdown-label {
            margin-bottom: 8px;
            font-weight: bold;
        }
        .dropdown {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        /* Active Layers Section */
        .active-layers {
            margin-top: 6px;
        }
        .active-layers h3 {
            margin: 8px 0 12px 0;
            font-size: 1rem;
            color: #333;
        }
        .layers-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .layer-card.dragging {
            opacity: 0.5;
            transform: scale(0.98);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .layer-card {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #e0e0e0;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .layer-card input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        .layer-title {
            flex: 1;
            font-size: 0.95rem;
            color: #111;
            padding-left: 4px;
        }
        .layer-actions {
            margin-left: 8px;
        }
        .three-dot-btn {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 4px 6px;
            border-radius: 4px;
        }
        .three-dot-btn:hover {
            background: rgba(0,0,0,0.04);
            color: #333;
        }
        /* Main Canvas */
        .main-canvas {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e9ecef;
            position: relative;
            overflow: hidden;
        }
        .basemap {
            width: 600px;
            height: 400px;
            background: #cce5ff;
            border: 2px solid #0078d4;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #0078d4;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        /* Right Panel */
        .right-panel {
            width: 380px;
            background: #f9fafb;
            border-left: 1px solid #ddd;
            padding: 24px 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-height: 0; /* allow child flex items to scroll */
            overflow: hidden;
        }
        /* Query Tool (bottom of right panel) */
        .query-tool {
            margin-top: 12px;
            border-top: 1px solid #e6e6e6;
            padding-top: 12px;
            display:flex;
            flex-direction:column;
            flex: 1 1 auto;
            min-height: 0; /* allow internal scrolling */
        }
        .query-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .query-tab {
            padding: 6px 10px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .query-tab.active {
            background: #0078d4;
            color: #fff;
            border-color: #0078d4;
        }
        .query-body {
            background: #fff;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 6px;
            display:flex;
            flex-direction:column;
            flex: 1 1 auto;
            min-height: 0;
        }
        .form-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .form-row label {
            white-space: nowrap;
            font-size: 0.9rem;
            color: #333;
        }
        .small-input {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .full-select {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .summary-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 18px;
        }
        .summary-item {
            margin-bottom: 14px;
            font-size: 1rem;
        }
        .summary-value {
            font-weight: bold;
            color: #0078d4;
            margin-left: 8px;
        }
                /* POI card styles (small modern) */
                .poi-card {
                    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
                    font-size: 13px; /* small font */
                    color: #111827;
                    background: #ffffff;
                    border-radius: 10px;
                    box-shadow: 0 6px 18px rgba(13, 38, 59, 0.06);
                    padding: 12px;
                    max-width: 100%;
                    border: 1px solid rgba(15, 23, 42, 0.04);
                }
                .poi-header { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
                .poi-title { font-weight:600; color:#0b5cff; font-size:13px; }
                .poi-sub { font-size:11px; color:#6b7280; }
                .poi-list { list-style: none; padding: 0; margin: 6px 0 0 0; }
                .poi-item { display:flex; gap:10px; padding:8px 6px; border-radius:8px; align-items:flex-start; }
                .poi-item + .poi-item { margin-top:6px; }
                .poi-rank { min-width:22px; height:22px; display:flex; align-items:center; justify-content:center; background:#eef2ff; color:#0b5cff; font-weight:700; border-radius:6px; font-size:12px; flex-shrink:0; }
                .poi-name { font-weight:600; color:#111827; font-size:13px; }
                .poi-desc { font-size:12px; color:#475569; margin-top:3px; line-height:1.2; }
                /* messages scroll area */
                #messages { flex: 1 1 auto; overflow-y: auto; padding: 8px; background:#fff; border:1px solid #eee; border-radius:6px; min-height:120px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Side Panel -->
        <div class="side-panel" id="sidePanel">
            <button class="collapse-btn" id="collapseBtn">&#9776; Collapse</button>
            <label class="dropdown-label" for="salesArea">Sales Area</label>
            <select class="dropdown" id="salesArea">
                <option>DDR</option>
                <option>State</option>
                <option>FL</option>
                <option>RD</option>
                <option>Entity Group</option>
                <option>Entity Sub Group</option>
            </select>
        </div>
        <!-- Main Canvas -->
        <div class="main-canvas">
            <div class="basemap">
                Basemap (India Focus)
            </div>
        </div>
        <!-- Right Panel -->
        <div class="right-panel">
            <div class="summary-title">Sales Summary</div>
            <div class="summary-item">Total Sales: <span class="summary-value">₹1,23,45,678</span></div>
            <div class="summary-item">Average Sales: <span class="summary-value">₹56,789</span></div>
            <div class="summary-item">Number of Outlets: <span class="summary-value">1,234</span></div>
            <!-- Query Tool (bottom) -->
            <div class="query-tool" id="queryTool">
                <div class="query-tabs">
                    <div class="query-tab active" data-tab="analysis">Analysis</div>
                    <!-- future tabs can be added here -->
                </div>
                <div class="query-body" id="queryBody">
                    <!-- Chat-based Analysis (replaces previous controls) -->
                    <div class="analysis-panel" id="analysisPanel" style="display:flex;flex-direction:column;flex:1 1 auto;min-height:0;">
                        <div id="chatContainer" style="display:flex;flex-direction:column;gap:8px;position:relative;flex:1 1 auto;min-height:0;">
                            <!-- loader overlay -->
                            <div id="loaderOverlay" style="display:none;position:absolute;inset:0;background:rgba(255,255,255,0.7);z-index:10;align-items:center;justify-content:center;border-radius:6px;">
                                <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                                    <div class="spinner" style="width:36px;height:36px;border:4px solid #e0e0e0;border-top-color:#0078d4;border-radius:50%;animation:spin 1s linear infinite;"></div>
                                    <div style="color:#333;font-size:0.9rem;">Processing...</div>
                                </div>
                            </div>
                            <style>@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>
                            <div id="messages"> 
                                <!-- chat messages will appear here -->
                            </div>
                            <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                                <input id="chatInput" type="text" placeholder="Type your message and press Enter..." style="flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;" />
                                <button id="sendBtn" class="collapse-btn" style="padding:6px 10px;">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Collapsible Side Panel Script -->
    <script>
        const collapseBtn = document.getElementById('collapseBtn');
        const sidePanel = document.getElementById('sidePanel');
        collapseBtn.onclick = function() {
            sidePanel.classList.toggle('collapsed');
            collapseBtn.textContent = sidePanel.classList.contains('collapsed') ? 'Expand' : '\u2630 Collapse';
        };
    </script>

    <script>
        // Add Active Layers markup dynamically into side panel if not already present
        (function insertActiveLayers() {
            const side = document.getElementById('sidePanel');
            if (!side) return;

            const container = document.createElement('div');
            container.className = 'active-layers';

            const title = document.createElement('h3');
            title.textContent = 'Active Layers';
            container.appendChild(title);

            const layers = ['DDR', 'coke outlets', 'RED outlets', 'Highway'];

            const list = document.createElement('div');
            list.className = 'layers-list';

            let dragSrc = null;

            function handleDragStart(e) {
                dragSrc = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                // required for Firefox
                e.dataTransfer.setData('text/plain', this.dataset.layer);
            }

            function handleDragEnd() {
                this.classList.remove('dragging');
                dragSrc = null;
            }

            function handleDragOver(e) {
                if (e.preventDefault) e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            function handleDrop(e) {
                if (e.stopPropagation) e.stopPropagation();
                if (dragSrc !== this) {
                    // Insert dragged element before the drop target
                    const parent = this.parentNode;
                    parent.insertBefore(dragSrc, this);
                }
                return false;
            }

            layers.forEach((name, idx) => {
                const card = document.createElement('div');
                card.className = 'layer-card';
                card.dataset.layer = name;
                card.draggable = true;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.id = `layer_cb_${idx}`;
                checkbox.addEventListener('change', (e) => {
                    // simple visual feedback - toggle opacity of title
                    titleEl.style.opacity = e.target.checked ? '1' : '0.5';
                });

                const titleEl = document.createElement('div');
                titleEl.className = 'layer-title';
                titleEl.textContent = name;

                const actions = document.createElement('div');
                actions.className = 'layer-actions';

                const threeDot = document.createElement('button');
                threeDot.className = 'three-dot-btn';
                threeDot.title = 'Layer properties';
                threeDot.innerHTML = '&#x22EE;'; // vertical ellipsis
                threeDot.addEventListener('click', () => {
                    // placeholder: show properties in console for now
                    console.log('Properties clicked for layer:', name);
                    alert(`Properties for layer: ${name}`);
                });

                actions.appendChild(threeDot);
                card.appendChild(checkbox);
                card.appendChild(titleEl);
                card.appendChild(actions);

                // drag events
                card.addEventListener('dragstart', handleDragStart, false);
                card.addEventListener('dragend', handleDragEnd, false);
                card.addEventListener('dragover', handleDragOver, false);
                card.addEventListener('drop', handleDrop, false);

                list.appendChild(card);
            });
            container.appendChild(list);

            // Insert after the existing dropdown (salesArea) so it appears in the side panel
            const salesArea = document.getElementById('salesArea');
            if (salesArea && salesArea.parentNode) {
                salesArea.parentNode.insertBefore(container, salesArea.nextSibling);
            } else {
                side.appendChild(container);
            }
        })();
    </script>
    <script>
        // Query Tool JS: chat UI behavior - display messages and POST to /ask
        (function setupQueryTool() {
            const messagesEl = document.getElementById('messages');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            function appendMessage(text, from = 'user') {
                const el = document.createElement('div');
                el.style.marginBottom = '8px';
                el.style.display = 'flex';
                el.style.justifyContent = from === 'user' ? 'flex-end' : 'flex-start';

                const bubble = document.createElement('div');
                bubble.textContent = text;
                bubble.style.maxWidth = '80%';
                bubble.style.padding = '8px 12px';
                bubble.style.borderRadius = '12px';
                bubble.style.background = from === 'user' ? '#0078d4' : '#f1f1f1';
                bubble.style.color = from === 'user' ? '#fff' : '#111';
                bubble.style.boxShadow = '0 1px 3px rgba(0,0,0,0.06)';

                el.appendChild(bubble);
                messagesEl.appendChild(el);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            async function sendQuestion(question) {
                appendMessage(question, 'user');

                // disable UI and show loader
                chatInput.disabled = true;
                sendBtn.disabled = true;
                const loader = document.getElementById('loaderOverlay');
                if (loader) loader.style.display = 'flex';

                try {
                    const resp = await fetch('http://localhost:8000/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question })
                    });

                    if (!resp.ok) {
                        const text = await resp.text();
                        appendMessage('Error: ' + resp.status + ' ' + text, 'bot');
                        return;
                    }

                    const data = await resp.json();
                    // assume the response has a top-level text field or answer
                    const reply = data.answer || data.text || JSON.stringify(data);
                    appendMessage(reply, 'bot');
                } catch (err) {
                    appendMessage('Request failed: ' + err.message, 'bot');
                } finally {
                    // re-enable UI and hide loader
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                    if (loader) loader.style.display = 'none';
                    chatInput.focus();
                }
            }

            function onSend() {
                const val = chatInput.value.trim();
                if (!val) return;
                chatInput.value = '';
                // send to backend
                sendQuestion(val);
            }

            sendBtn.addEventListener('click', onSend);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    onSend();
                }
            });

            // Optional: seed with a welcome message
            appendMessage('Welcome! Ask a question about POIs or hotspots. Example: "Identify some tourist hotspots in Delhi area?"', 'bot');

            // Tab switching (only analysis tab now) - keep visual behavior
            const tabs = document.querySelectorAll('.query-tab');
            tabs.forEach(tab => tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            }));
        })();
    </script>
        <script>
        // POI formatting helper functions
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatPoiTextToHtml(raw) {
            if (!raw || typeof raw !== 'string') return '';
            const norm = raw.replace(/\r\n/g, '\n').trim();
            let parts = norm.split(/\n/).map(s => s.trim()).filter(Boolean);
            if (parts.length === 1) {
                const splitByNum = norm.split(/\s*\d+\.\s*/).map(s => s.trim()).filter(Boolean);
                if (splitByNum.length > 1) parts = splitByNum;
            }
            const items = parts.map((p) => {
                const short = p.replace(/\s*Enjoy[\s\S]*$/i, '').trim();
                const [left, ...rest] = short.split(/\s*[-–—]\s*/);
                const titleRaw = left || short;
                const desc = rest.join(' - ') || '';
                const title = titleRaw.replace(/\*\*(.*?)\*\*/g, '$1').replace(/^\d+\.\s*/, '').trim();
                return { name: title, desc: desc };
            }).filter(it => it.name);
            const header = `<div class="poi-header"><div class="poi-title">Cafes in Delhi</div><div class="poi-sub">${items.length} results</div></div>`;
            const listItems = items.map((it, idx) => {
                return `\n      <li class="poi-item">\n        <div class="poi-rank">${idx+1}</div>\n        <div style="flex:1">\n          <div class="poi-name">${escapeHtml(it.name)}</div>\n          ${it.desc ? `<div class="poi-desc">${escapeHtml(it.desc)}</div>` : ''}\n        </div>\n      </li>`;
            }).join('\n');
            return `<div class="poi-card">${header}<ul class="poi-list">${listItems}</ul></div>`;
        }

        function appendBotHtml(html) {
            const wrapper = document.createElement('div');
            wrapper.style.marginBottom = '8px';
            wrapper.style.display = 'flex';
            wrapper.style.justifyContent = 'flex-start';
            wrapper.innerHTML = html;
            const messagesEl = document.getElementById('messages');
            if (!messagesEl) return;
            const cardContainer = document.createElement('div');
            cardContainer.style.maxWidth = '100%';
            cardContainer.appendChild(wrapper);
            messagesEl.appendChild(cardContainer);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        </script>
</body>
</html>